<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   script-src 'self' 'unsafe-eval'; 
                   style-src 'self' 'unsafe-inline'; 
                   img-src 'self' data: blob:;
                   font-src 'self' data:;">
    <meta name="description" content="æœƒè¨ˆäº‹å‹™æ‰€å…§æ§ä½œæ¥­ç³»çµ± - é›¢ç·šç¨…å‹™è¨ˆç®—èˆ‡æ¡ˆä»¶ç®¡ç†">
    <title>æœƒè¨ˆäº‹å‹™æ‰€å…§æ§ä½œæ¥­ç³»çµ±</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./public/icons/favicon.svg">
    <link rel="manifest" href="./manifest.json">
    
    <!-- PrimeVue CSS -->
    <link rel="stylesheet" href="./public/libs/primevue/themes/lara-light-blue/theme.css">
    <link rel="stylesheet" href="./public/libs/primevue/core/core.min.css">
    <link rel="stylesheet" href="./public/libs/primeicons/primeicons.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="./src/assets/styles/variables.css">
    <link rel="stylesheet" href="./src/assets/styles/main.css">
    <link rel="stylesheet" href="./src/assets/styles/theme.css">
    <link rel="stylesheet" href="./src/assets/styles/utilities.css">
</head>
<body>
    <div id="app">
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <p>ç³»çµ±è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- ç¬¬ä¸‰æ–¹åº«ï¼ˆæœ¬åœ°å¼•ç”¨ï¼ŒæŒ‰ä¾è³´é †åºè¼‰å…¥ï¼‰ -->
    <!-- æ ¸å¿ƒå·¥å…·åº« -->
    <script src="./public/libs/decimal.min.js"></script>
    <script src="./public/libs/dayjs.min.js"></script>
    <script src="./public/libs/dayjs-locale-zh-tw.min.js"></script>
    <script src="./public/libs/lodash.min.js"></script>
    <script src="./public/libs/dompurify.min.js"></script>
    
    <!-- æ•¸æ“šæŒä¹…åŒ– -->
    <script src="./public/libs/dexie.min.js"></script>
    
    <!-- PDF ç”Ÿæˆèˆ‡è™•ç† -->
    <script src="./public/libs/jspdf.umd.min.js"></script>
    <script src="./public/libs/pdf-lib.min.js"></script>
    <script src="./public/libs/pdfjs/pdf.min.js"></script>
    
    <!-- HTML è½‰åœ–ç‰‡/PDF -->
    <script src="./public/libs/html2canvas.min.js"></script>
    
    <!-- æ–‡ä»¶è™•ç† -->
    <script src="./public/libs/file-saver.min.js"></script>
    <script src="./public/libs/jszip.min.js"></script>
    <script src="./public/libs/xlsx.full.min.js"></script>
    <script src="./public/libs/exceljs.min.js"></script>
    
    <!-- åœ–è¡¨åº« -->
    <script src="./public/libs/chart.umd.min.js"></script>
    <script src="./public/libs/echarts.min.js"></script>
    
    <!-- OCR å¼•æ“ï¼ˆPaddleOCR + ONNX Runtimeï¼‰-->
    <script src="./public/libs/onnxruntime-web.min.js"></script>
    
    <!-- Vue ç”Ÿæ…‹ç³»çµ± -->
    <script src="./public/libs/vue.global.prod.js"></script>
    <script src="./public/libs/vue-router.global.prod.js"></script>
    <script src="./public/libs/pinia.iife.prod.js"></script>
    
    <!-- PrimeVue çµ„ä»¶åº« -->
    <script src="./public/libs/primevue/primevue.min.js"></script>
    
    <!-- OCR æ ¸å¿ƒæ¨¡çµ„ï¼ˆPaddleOCR å¼•æ“ï¼‰-->
    <script src="./src/core/engines/ocr/PaddleOCREngine.js"></script>
    <script src="./src/core/engines/ocr/OCRPreprocessor.js"></script>
    <script src="./src/core/engines/ocr/InvoiceScanner.js"></script>
    
    <!-- OCR æ™ºèƒ½é©—è­‰æ¨¡çµ„ -->
    <script src="./src/core/engines/ocr/InvoiceFieldMapper.js"></script>
    <script src="./src/core/engines/ocr/InvoiceValidator.js"></script>
    <script src="./src/core/engines/ocr/ExcelImageExporter.js"></script>
    
    <!-- å…¨å±€éŒ¯èª¤è™•ç† -->
    <script>
        // ç°¡åŒ–ç‰ˆéŒ¯èª¤è™•ç†ï¼ˆç„¡å¤–éƒ¨ä¾è³´ï¼‰
        window.addEventListener('error', (event) => {
            console.error('ğŸ”´ å…¨å±€éŒ¯èª¤:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('ğŸ”´ æœªè™•ç†çš„ Promise éŒ¯èª¤:', event.reason);
        });
        
        // æª¢æ¸¬å¿…éœ€çš„å…¨å±€å°è±¡
        window.addEventListener('DOMContentLoaded', () => {
            const requiredLibs = {
                'Vue': typeof Vue !== 'undefined',
                'VueRouter': typeof VueRouter !== 'undefined',
                'Pinia': typeof Pinia !== 'undefined',
                'Dexie': typeof Dexie !== 'undefined',
                'Decimal': typeof Decimal !== 'undefined',
                'DOMPurify': typeof DOMPurify !== 'undefined',
                'jsPDF': typeof window.jspdf !== 'undefined',
                'Chart.js': typeof Chart !== 'undefined',
                'ONNX Runtime': typeof ort !== 'undefined',
                'PaddleOCR': typeof PaddleOCREngine !== 'undefined',
                'OCR Preprocessor': typeof OCRPreprocessor !== 'undefined',
                'Invoice Scanner': typeof InvoiceScanner !== 'undefined'
            };
            
            let allLoaded = true;
            for (const [name, loaded] of Object.entries(requiredLibs)) {
                if (!loaded) {
                    console.error(`âŒ å¿…éœ€åº«æœªè¼‰å…¥: ${name}`);
                    allLoaded = false;
                } else {
                    console.log(`âœ… ${name} å·²è¼‰å…¥`);
                }
            }
            
            if (!allLoaded) {
                document.getElementById('app').innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: sans-serif;">
                        <h2 style="color: #e74c3c;">âš ï¸ ç³»çµ±è¼‰å…¥å¤±æ•—</h2>
                        <p>éƒ¨åˆ†å¿…éœ€åº«æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š</p>
                        <ol style="text-align: left; max-width: 500px; margin: 20px auto;">
                            <li>åŸ·è¡Œï¼š<code>python3 download_libs.py</code></li>
                            <li>ç¢ºèª <code>public/libs/</code> ç›®éŒ„å­˜åœ¨</li>
                            <li>é‡æ–°è¼‰å…¥é é¢</li>
                        </ol>
                    </div>
                `;
            }
        });
    </script>
    
    <!-- æ‡‰ç”¨å…¥å£ -->
    
    <!-- ä¾è³´æª¢æŸ¥è…³æœ¬ -->
    <script>
        // ç¢ºä¿æ‰€æœ‰ä¾è³´è¼‰å…¥å®Œæˆ
        function checkDependencies() {
            const required = ['Vue', 'VueRouter', 'Pinia', 'PrimeVue'];
            const missing = required.filter(name => typeof window[name] === 'undefined');

            if (missing.length > 0) {
                console.error('âŒ ç¼ºå°‘ä¾è³´:', missing);
                document.querySelector('.loading-screen p').textContent = 
                    'è¼‰å…¥å¤±æ•—ï¼šç¼ºå°‘ ' + missing.join(', ');
                return false;
            }

            console.log('âœ… æ‰€æœ‰ä¾è³´å·²è¼‰å…¥');
            return true;
        }

        // ç­‰å¾…æ‰€æœ‰è…³æœ¬è¼‰å…¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!checkDependencies()) {
                    console.error('ä¾è³´æª¢æŸ¥å¤±æ•—ï¼Œåœæ­¢è¼‰å…¥ main.js');
                }
            }, 100);
        });
    </script>

    <script type="module" src="./src/main.js"></script>
    
    <script>
        // Service Worker è¨»å†Šï¼ˆéœé»˜å¤±æ•—ï¼Œä¸é˜»æ­¢æ‡‰ç”¨é‹è¡Œï¼‰
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('âœ… Service Worker è¨»å†ŠæˆåŠŸ:', reg.scope))
                    .catch(err => {
                        console.warn('âš ï¸ Service Worker è¨»å†Šå¤±æ•—ï¼ˆé›¢ç·šåŠŸèƒ½å¯èƒ½å—é™ï¼‰:', err.message);
                        // ä¸é˜»æ­¢æ‡‰ç”¨é‹è¡Œ
                    });
            });
        }
        
        // PDF.js Worker é…ç½®ï¼ˆæª¢æŸ¥å¾Œå†é…ç½®ï¼‰
        if (typeof pdfjsLib !== 'undefined' || typeof window['pdfjs-dist/build/pdf'] !== 'undefined') {
            const pdfjs = pdfjsLib || window['pdfjs-dist/build/pdf'];
            if (pdfjs && pdfjs.GlobalWorkerOptions) {
                pdfjs.GlobalWorkerOptions.workerSrc = './public/libs/pdfjs/pdf.worker.min.js';
                console.log('âœ… PDF.js Worker å·²é…ç½®');
            }
        } else {
            console.warn('âš ï¸ PDF.js æœªè¼‰å…¥ï¼ˆPDF è§£æåŠŸèƒ½æš«ä¸å¯ç”¨ï¼‰');
        }
        
        // Day.js èªç³»é…ç½®
        if (typeof dayjs !== 'undefined') {
            dayjs.locale('zh-tw');
            console.log('âœ… Day.js ä¸­æ–‡èªç³»å·²è¨­å®š');
        }
    </script>
</body>
</html>
